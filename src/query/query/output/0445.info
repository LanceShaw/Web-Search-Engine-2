「这年头还有安全的 USB 设备吗？」

欧阳洋葱
* FreeBuf 专题报道，未经许可禁止转载在正式开谈 USB 安全之前，还是照例来分享一个很有意思的案例：2014 年年末，来自 Reddit 的报道，某大公司高管电脑感染了恶意程序。公司的安全研究人员就调查恶意程序来源，但检查了所有传统可能的感染途经都一无所获。于是他们开始考虑其他突破口，从这位高管的饮食起居入手，翻来覆去地查，最后发现问题居然出在高管的电子烟身上。“这是一款中国造的电子烟，充电装置部分包含了硬件编码的恶意程序。”而这款电子烟是通过 USB 口充电的，这名高管为了充电，顺手会将其插入到公司的电脑上，于是电脑就感染了恶意程序。在这一例中，如果恶意程序做得更加隐秘，那么整个攻击过程甚至可以达到神不知鬼不觉。这其中的传播核心，就是我们要谈的“USB 安全”。USB 安全？这是什么意思？我们擅自提“USB 安全”这个词汇，其实是不准确的。因为 USB 本质上只是一种通用串行总线——总线有很多啊，SATA 总线、PCIe 总线等等，这有什么样的安全话题可谈呢？可能 USB 充其量可作为恶意程序传播的途经。我们说“USB 安全”，和说“网线安全”是不是感觉差不多荒谬？不过大概是因为 USB 作为替代古代各种接口的明星级统一标准，而且 USB 又不像 Thunderbolt 之类的接口一样需要高昂的授权费用，当代世界的海量设备采用 USB 接口也是种必然。有趣的是，我们经常将采用 USB 接口的设备称作 USB 设备（却没有人将 PC 内置的硬盘称作 SATA 设备或者 PCIe 设备），这也是我们这里谈 USB 安全的基础。由于 USB 当代的使用如此广泛，所以 USB 设备也就成为了恶意程序传播的重要载体。但如果只说 USB 设备作为恶意程序的传播途径，那么任何接口实际上也都存在这种传播的可行性。比如说 U 盘能够传播病毒，Thunderbolt 移动硬盘也行，连光盘都可以。总的说来，我们要谈所谓的 USB 安全，并不是 USB 在数据传输过程中存在安全问题，或者某类 USB 接口规格（如 Type-C）某个针脚存在设计缺陷，而是 USB 接口或总线作为恶意程序的一个重要途经，存在安全问题，以及 USB 协议、驱动存在的安全问题。因此针对 USB 安全，有 3 点可谈。其一，USB 是个具有相当普遍性的标准，鼠标、键盘、电子烟、外置声卡都用 USB 接口，且即插即用。所以在物理接口中，它对恶意程序的传播大概是除了网络适配器接口之外，效率最高的。其二，USB 协议可被攻击者利用，这也将是本文要谈到的重点。其三，最高级的 USB 0day 漏洞攻击。autorun.inf 时代！U 盘病毒？在网络还不像现在这么盛行的年代，可移动存储设备是传播病毒的重要方式。就是将恶意程序放在 U 盘，或者移动硬盘，甚至软盘中——在不同的 PC 交换数据的过程中，就可以达到传播病毒的作用。再高明的恶意程序也需要人类去打开才能运行，巧在像 Windows 这类操作系统，为了加强使用体验，系统中有个针对移动存储介质的 AutoPlay/AutoRun 自动播放功能。原本自动播放的功能是，针对 CD/DVD 多媒体光盘可实现插入即播放，而针对 Windows 安装介质，插入就能立即弹出安装程序。绝大部分同学应该都知道移动存储介质的根目录下的 autorun.inf 文件就负责自动播放功能，打开形如以下样式：[autorun] open=setup.exe icon=setup.exe,0label=My install CD
